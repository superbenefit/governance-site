---
/**
 * Custom Sidebar Component for SuperBenefit Governance Site
 *
 * Overrides Starlight's default Sidebar to dynamically generate navigation
 * from governance content collections (agreements, policies, proposals).
 */
import { getCollection } from 'astro:content';
import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro';
import MobileMenuFooter from 'virtual:starlight/components/MobileMenuFooter';

// Get all entries from governance collections
const agreements = await getCollection('agreements');
const policies = await getCollection('policies');
const proposals = await getCollection('proposals');

/**
 * Build hierarchical navigation structure from collection entries
 */
function buildNavTree(entries: any[], collectionName: string) {
	const grouped = entries.reduce((acc, entry) => {
		const parts = entry.id.split('/');
		const groupKey = parts.length > 1 ? parts[0] : '_root';
		if (!acc[groupKey]) acc[groupKey] = [];
		acc[groupKey].push(entry);
		return acc;
	}, {} as Record<string, typeof entries>);

	Object.keys(grouped).forEach(key => {
		grouped[key].sort((a, b) => {
			const titleA = a.data.title || a.id;
			const titleB = b.data.title || b.id;
			return titleA.localeCompare(titleB);
		});
	});

	return grouped;
}

const agreementsTree = buildNavTree(agreements, 'agreements');
const policiesTree = buildNavTree(policies, 'policies');
const proposalsTree = buildNavTree(proposals, 'proposals');

function formatGroupName(key: string): string {
	if (key === '_root') return '';
	return key
		.split('-')
		.map(word => word.charAt(0).toUpperCase() + word.slice(1))
		.join(' ');
}

const currentPath = Astro.url.pathname;
---

<SidebarPersister>
	<ul class="top-level">
		<!-- Agreements Section -->
		<li>
			<details open>
				<summary>
					<div class="large">Agreements</div>
				</summary>
				<ul>
					<li>
						<a href="/agreements/" aria-current={currentPath === '/agreements/' ? 'page' : 'false'}>
							<span>Overview</span>
						</a>
					</li>
					{Object.entries(agreementsTree).map(([groupKey, items]) => (
						groupKey === '_root' ? (
							items.map(entry => (
								<li>
									<a
										href={`/agreements/${entry.id}/`}
										aria-current={currentPath === `/agreements/${entry.id}/` ? 'page' : 'false'}
									>
										<span>{entry.data.title || entry.id}</span>
									</a>
								</li>
							))
						) : (
							<li>
								<details open>
									<summary>
										<div>{formatGroupName(groupKey)}</div>
									</summary>
									<ul>
										{items.map(entry => (
											<li>
												<a
													href={`/agreements/${entry.id}/`}
													aria-current={currentPath === `/agreements/${entry.id}/` ? 'page' : 'false'}
												>
													<span>{entry.data.title || entry.id.split('/').pop()}</span>
												</a>
											</li>
										))}
									</ul>
								</details>
							</li>
						)
					))}
				</ul>
			</details>
		</li>

		<!-- Policies Section -->
		<li>
			<details open>
				<summary>
					<div class="large">Policies</div>
				</summary>
				<ul>
					<li>
						<a href="/policies/" aria-current={currentPath === '/policies/' ? 'page' : 'false'}>
							<span>Overview</span>
						</a>
					</li>
					{Object.entries(policiesTree).map(([groupKey, items]) => (
						groupKey === '_root' ? (
							items.map(entry => (
								<li>
									<a
										href={`/policies/${entry.id}/`}
										aria-current={currentPath === `/policies/${entry.id}/` ? 'page' : 'false'}
									>
										<span>{entry.data.title || entry.id}</span>
									</a>
								</li>
							))
						) : (
							<li>
								<details open>
									<summary>
										<div>{formatGroupName(groupKey)}</div>
									</summary>
									<ul>
										{items.map(entry => (
											<li>
												<a
													href={`/policies/${entry.id}/`}
													aria-current={currentPath === `/policies/${entry.id}/` ? 'page' : 'false'}
												>
													<span>{entry.data.title || entry.id.split('/').pop()}</span>
												</a>
											</li>
										))}
									</ul>
								</details>
							</li>
						)
					))}
				</ul>
			</details>
		</li>

		<!-- Proposals Section -->
		<li>
			<details open>
				<summary>
					<div class="large">Proposals</div>
				</summary>
				<ul>
					<li>
						<a href="/proposals/" aria-current={currentPath === '/proposals/' ? 'page' : 'false'}>
							<span>Overview</span>
						</a>
					</li>
					{Object.entries(proposalsTree).map(([groupKey, items]) => (
						groupKey === '_root' ? (
							items.map(entry => (
								<li>
									<a
										href={`/proposals/${entry.id}/`}
										aria-current={currentPath === `/proposals/${entry.id}/` ? 'page' : 'false'}
									>
										<span>{entry.data.title || entry.id}</span>
									</a>
								</li>
							))
						) : (
							<li>
								<details open>
									<summary>
										<div>{formatGroupName(groupKey)}</div>
									</summary>
									<ul>
										{items.map(entry => (
											<li>
												<a
													href={`/proposals/${entry.id}/`}
													aria-current={currentPath === `/proposals/${entry.id}/` ? 'page' : 'false'}
												>
													<span>{entry.data.title || entry.id.split('/').pop()}</span>
												</a>
											</li>
										))}
									</ul>
								</details>
							</li>
						)
					))}
				</ul>
			</details>
		</li>

		<!-- Reference Section (de-emphasized) -->
		<li class="reference-section">
			<details>
				<summary>
					<div class="large">Reference</div>
				</summary>
				<ul>
					<li>
						<a href="/governance/" aria-current={currentPath === '/governance/' ? 'page' : 'false'}>
							<span>Governance Framework</span>
						</a>
					</li>
					<li>
						<a href="/code-of-conduct/" aria-current={currentPath === '/code-of-conduct/' ? 'page' : 'false'}>
							<span>Code of Conduct</span>
						</a>
					</li>
					<li>
						<a href="/contributing/" aria-current={currentPath === '/contributing/' ? 'page' : 'false'}>
							<span>Contributing</span>
						</a>
					</li>
				</ul>
			</details>
		</li>
	</ul>
</SidebarPersister>

<div class="md:sl-hidden">
	<MobileMenuFooter />
</div>

<style>
	.reference-section {
		margin-top: 2rem;
		padding-top: 1.5rem;
		border-top: 1px solid var(--sl-color-gray-5);
	}

	.reference-section summary {
		opacity: 0.7;
	}

	.reference-section a {
		opacity: 0.8;
	}

	.reference-section summary:hover,
	.reference-section a:hover {
		opacity: 1;
	}
</style>
