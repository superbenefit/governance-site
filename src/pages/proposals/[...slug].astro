---
/**
 * Dynamic route for governance proposals
 *
 * Generates pages for all entries in the 'proposals' collection.
 * Uses Starlight components for consistent UI/aesthetics.
 *
 * Routes generated:
 * - /proposals/* (Snapshot proposals from superbenefit.eth)
 *
 * Enhanced to display Snapshot-specific voting metadata including:
 * - Voting results and winning choice
 * - Proposal author and dates
 * - Participation metrics
 */
import { getCollection } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

export async function getStaticPaths() {
	const proposals = await getCollection('proposals');
	return proposals.map(entry => ({
		params: { slug: entry.id },
		props: { entry },
	}));
}

const { entry } = Astro.props;

// Note: We're storing HTML directly, so we don't need to render markdown
// Use title from frontmatter
const title = entry.data.title || 'Untitled';
const frontmatter = { ...entry.data, title };

// Helper function to format dates
const formatDate = (date: Date | undefined) => {
	if (!date) return 'N/A';
	return new Intl.DateTimeFormat('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
	}).format(date);
};

// Helper function to shorten Ethereum addresses
const shortenAddress = (address: string | undefined) => {
	if (!address) return 'Unknown';
	return `${address.slice(0, 6)}...${address.slice(-4)}`;
};
---

<StarlightPage {frontmatter} headings={[]}>
	{/* Proposal body content (converted from markdown to HTML) */}
	{entry.body && (
		<div class="sl-markdown-content" set:html={entry.body} />
	)}

	{!entry.body && (
		<div style="
			padding: 2rem;
			background: var(--sl-color-gray-6, #23262f);
			border-radius: 0.5rem;
			text-align: center;
			color: var(--sl-color-gray-3, #888c96);
			margin-bottom: 2rem;
		">
			<p>No proposal content available.</p>
			<p style="font-size: 0.875rem; margin-top: 0.5rem;">
				This proposal may not have included a description, or the content could not be loaded.
			</p>
		</div>
	)}

	{entry.data.snapshotId && (
		<div class="snapshot-metadata">
			<div class="voting-results-header">
				<div class="header-content">
					<h2>Voting Results</h2>
					{entry.data.status && (
						<span class="status-badge">
							{entry.data.status}
						</span>
					)}
				</div>
			</div>

			<div class="metadata-grid">
				{entry.data.winningChoice && (
					<div>
						<strong class="metadata-label">Result</strong>
						<div class="metadata-value-large">
							{entry.data.winningChoice}
						</div>
					</div>
				)}

				{entry.data.percentageVoted !== undefined && (
					<div>
						<strong class="metadata-label">Winning Vote</strong>
						<div class="metadata-value-large metadata-accent">
							{entry.data.percentageVoted.toFixed(2)}%
						</div>
					</div>
				)}

				{entry.data.votes !== undefined && (
					<div>
						<strong class="metadata-label">Total Voters</strong>
						<div class="metadata-value-large">
							{entry.data.votes}
						</div>
					</div>
				)}
			</div>

			{entry.data.choices && entry.data.scores && (
				<details class="choices-details">
					<summary class="choices-summary">
						ðŸ“Š View All Choices & Scores
					</summary>
					<div class="choices-content">
						{entry.data.choices.map((choice: string, index: number) => (
							<div class="choice-row">
								<span class="choice-name">{choice}</span>
								<span class="choice-score">
									{entry.data.scores![index]?.toFixed(2) || 0}
									<span class="choice-percentage">
										{' '}({entry.data.scores_total ? ((entry.data.scores![index] / entry.data.scores_total) * 100).toFixed(2) : 0}%)
									</span>
								</span>
							</div>
						))}
					</div>
				</details>
			)}

			<div class="metadata-footer">
				{entry.data.author && (
					<div>
						<strong class="metadata-label">Author</strong>
						<div class="metadata-value-mono">
							{shortenAddress(entry.data.author)}
						</div>
					</div>
				)}

				{entry.data.startDate && (
					<div>
						<strong class="metadata-label">Start Date</strong>
						<div class="metadata-value">
							{formatDate(entry.data.startDate)}
						</div>
					</div>
				)}

				{entry.data.endDate && (
					<div>
						<strong class="metadata-label">End Date</strong>
						<div class="metadata-value">
							{formatDate(entry.data.endDate)}
						</div>
					</div>
				)}

				{entry.data.snapshotId && (
					<div>
						<strong class="metadata-label">View Original</strong>
						<div>
							<a
								href={`https://snapshot.org/#/superbenefit.eth/proposal/${entry.data.snapshotId}`}
								target="_blank"
								rel="noopener noreferrer"
								class="snapshot-link"
							>
								Snapshot.org â†—
							</a>
						</div>
					</div>
				)}
			</div>
		</div>
	)}
</StarlightPage>
