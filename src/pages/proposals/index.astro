---
import { getCollection, render } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { readFile } from 'node:fs/promises';
import { Marked } from 'marked';

// Try to read and parse the index.md file from the governance submodule
// Fall back to default content if the file doesn't exist (e.g., submodule not initialized)
const indexPath = './src/content/governance/proposals/index.md';
let description = 'Institutional memory archive preserving decision-making processes and deliberative context';
let title = 'Proposals';
let renderedContent = '<p>Historical record of governance proposals and their outcomes.</p>';

try {
	const indexContent = await readFile(indexPath, 'utf-8');

	// Extract frontmatter
	const frontmatterMatch = indexContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
	let markdownContent = indexContent;

	if (frontmatterMatch) {
		const frontmatter = frontmatterMatch[1];
		markdownContent = frontmatterMatch[2];
		const descMatch = frontmatter.match(/description:\s*(.+)/);
		if (descMatch) {
			description = descMatch[1];
		}
	}

	// Get title from first H1 and remove it from content
	const titleMatch = markdownContent.match(/^#\s+(.+)$/m);
	title = titleMatch ? titleMatch[1] : 'Proposals';
	const contentWithoutTitle = markdownContent.replace(/^#\s+.+$/m, '').trim();

	// Render markdown to HTML
	const marked = new Marked();
	renderedContent = await marked.parse(contentWithoutTitle);
} catch (error) {
	// Submodule not initialized or file doesn't exist - use defaults
	console.log('Using default proposal index content');
}

// Get all proposals and extract titles
const proposals = await getCollection('proposals');

// Extract titles from each proposal
const proposalsWithTitles = await Promise.all(
	proposals.map(async (proposal) => {
		const { headings } = await render(proposal);
		const displayTitle = proposal.data.title || headings.find(h => h.depth === 1)?.text || proposal.id;
		return { ...proposal, displayTitle };
	})
);

// Sort by endDate (most recent first) for Snapshot proposals, fall back to lastUpdated, then title
const sortedProposals = proposalsWithTitles.sort((a, b) => {
	// For Snapshot proposals, sort by endDate
	if (a.data.endDate && b.data.endDate) {
		return b.data.endDate.getTime() - a.data.endDate.getTime();
	}
	// Fall back to lastUpdated if available
	if (a.data.lastUpdated && b.data.lastUpdated) {
		return b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime();
	}
	// Finally sort alphabetically by title
	return a.displayTitle.localeCompare(b.displayTitle);
});
---

<StarlightPage frontmatter={{ title, description }}>
	<div class="sl-markdown-content">
		<div set:html={renderedContent} />

		<hr />

		<h2>Browse All Proposals</h2>
		{sortedProposals.length === 0 ? (
			<p class="empty-state">
				No proposals have been archived yet. This collection will grow as governance decisions are documented.
			</p>
		) : (
			<ul class="entry-list">
				{sortedProposals.map(proposal => (
					<li class="entry-item">
						<a href={`/proposals/${proposal.id}/`} class="entry-link">
							<strong class="entry-title">{proposal.displayTitle}</strong>
							{proposal.data.description && (
								<p class="entry-description">{proposal.data.description}</p>
							)}
						</a>
						{proposal.data.status && (
							<span class={`status-badge status-${proposal.data.status}`}>
								{proposal.data.status}
							</span>
						)}
					</li>
				))}
			</ul>
		)}
	</div>

	<style>
		hr {
			margin: 3rem 0;
			border: none;
			border-top: 1px solid var(--sl-color-gray-5);
		}

		.empty-state {
			padding: 2rem;
			background: var(--sl-color-gray-6);
			border-radius: 0.5rem;
			text-align: center;
			color: var(--sl-color-gray-2);
		}

		.entry-list {
			list-style: none;
			padding: 0;
			display: grid;
			gap: 1rem;
		}

		.entry-item {
			border: 1px solid var(--sl-color-gray-5);
			border-radius: 0.5rem;
			padding: 1rem;
			transition: border-color 0.2s;
			position: relative;
		}

		.entry-item:hover {
			border-color: var(--sl-color-accent);
		}

		.entry-link {
			text-decoration: none;
			color: inherit;
			display: block;
			padding-right: 6rem; /* Reserve space for status badge */
		}

		.entry-title {
			color: var(--sl-color-white);
			font-size: 1.1rem;
			display: block;
			margin-bottom: 0.5rem;
		}

		.entry-description {
			color: var(--sl-color-gray-3);
			margin: 0;
			font-size: 0.9rem;
		}

		.status-badge {
			position: absolute;
			top: 1rem;
			right: 1rem;
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
			border-radius: 0.25rem;
			text-transform: uppercase;
			font-weight: bold;
		}

		.status-draft {
			background: var(--sl-color-orange-low);
			color: var(--sl-color-orange-high);
		}

		.status-active {
			background: var(--sl-color-green-low);
			color: var(--sl-color-green-high);
		}

		.status-deprecated {
			background: var(--sl-color-gray-5);
			color: var(--sl-color-gray-3);
		}

		.status-passed {
			background: var(--sl-color-green-low);
			color: var(--sl-color-green-high);
		}

		.status-rejected {
			background: var(--sl-color-red-low);
			color: var(--sl-color-red-high);
		}
	</style>
</StarlightPage>
